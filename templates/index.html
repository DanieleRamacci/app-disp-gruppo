<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ title }}</title>
  <style>
    :root{--gap:12px;--r:14px;--txt:#111827;--mut:#6b7280;--card:#f7f9fc;--bd:#e5e7eb;--bg:#ffffff;--primary:#2563eb;--danger:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;color:var(--txt);background:#fff}
    .hidden{display:none !important}

    .container{max-width:980px;margin:0 auto;padding:12px}
    .pm-btn{background:#fff;border:1px solid var(--bd);color:var(--txt);border-radius:12px;padding:10px 14px;cursor:pointer;transition:all .2s;font-weight:600}
    .pm-btn:hover{background:#f9fafb}
    .pm-card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:14px;margin-bottom:12px}
    .pm-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:var(--gap)}
    .pm-row{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
    .pm-muted{color:var(--mut)}
    .pm-name{font-weight:700}
    .pm-badge{background:#f3f4f6;border:1px solid var(--bd);padding:6px 10px;border-radius:999px;color:var(--txt)}
    .pm-stat{background:#fff;border:1px solid var(--bd);border-radius:999px;padding:6px 10px;font-size:13px}
    .pm-pill{border-radius:999px;padding:12px 14px;border:1px solid var(--bd);background:#fff;color:var(--txt);font-size:15px;font-weight:600;transition:all .2s;flex:1;min-width:110px;text-align:center}
    .pm-pill:hover{background:#f3f4f6}
    .pm-pill.sel{background:var(--primary);border-color:var(--primary);color:#fff}
    input[type="text"], input[type="password"]{width:100%;background:#fff;border:1px solid var(--bd);border-radius:10px;padding:12px;font-size:16px}
    .pm-chips{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px}
    .pm-chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#fff;border:1px solid var(--bd);cursor:pointer;font-size:13px;user-select:none}
    .pm-chip:hover{background:#f9fafb}

    /* bar fissa */
    .pm-fixedbar{position:sticky;top:0;z-index:999;background:#fff;border-bottom:1px solid var(--bd)}
    .pm-fixedbar-inner{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 12px}
    .pm-fixedbar-title{font-weight:700}

    /* monthbar */
    .pm-monthbar{position:sticky;top:48px;z-index:8;background:#fff;padding:8px;border-bottom:1px solid var(--bd);display:flex;gap:8px;overflow:auto}
    .pm-month{white-space:nowrap;border:1px solid var(--bd);background:#fff;border-radius:999px;padding:6px 10px;cursor:pointer}
    .pm-month.active{background:#e8effe;border-color:#cfe0ff}

    /* summary / soglia */
    .pm-rowcard{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:12px}
    .pm-dot{display:inline-block;width:10px;height:10px;border-radius:999px;background:var(--danger);margin-right:6px;vertical-align:baseline}
    .pm-columns{display:grid;grid-template-columns:1fr;gap:10px}
    @media (min-width:720px){ .pm-columns{grid-template-columns:repeat(2,1fr);} }
    .pm-col h4{margin:0 0 6px 0;font-size:14px;color:#374151}
    .pm-list{margin:0;padding-left:16px}
    .pm-list li{margin:2px 0}

    /* collapse dettagli */
    .pm-collapse{border-top:1px dashed var(--bd);margin-top:10px;padding-top:10px}
    .pm-collapse-btn{display:inline-flex;align-items:center;gap:6px}
    .pm-caret{display:inline-block;transition:transform .2s}
    .pm-caret.open{transform:rotate(90deg)}

    /* overlay spinner */
    .pm-overlay{position:fixed;inset:0;background:rgba(255,255,255,.7);display:none;flex-direction:column;gap:10px;align-items:center;justify-content:center;padding:20px;z-index:9999}
    .pm-loader{width:42px;height:42px;border-radius:50%;border:4px solid #e5e7eb;border-top-color:var(--primary);animation:pm-spin .9s linear infinite}
    .pm-loadtext{font-weight:600;color:#111827}
    @keyframes pm-spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="pm-root"
       data-weeks="{{ weeks }}"
       data-min="{{ min_presence }}"
       data-logged="{{ 1 if user else 0 }}"
       data-user="{{ user|e if user else '' }}">

    <div class="pm-fixedbar">
      <div class="pm-fixedbar-inner container">
        <div class="pm-fixedbar-title">Presenze Martedì</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="pm-btn js-auth js-go-choices hidden">Scelte</button>
          <button class="pm-btn js-auth js-go-summary hidden">Riepilogo</button>
          <button class="pm-btn js-auth js-logout hidden">Esci</button>
        </div>
      </div>
    </div>

    <div class="container">
      <!-- header/badge -->
      <div class="pm-row" style="justify-content:space-between">
        <h2>Presenze Martedì</h2>
        <span id="pmBadge" class="pm-badge hidden"></span>
      </div>

      <!-- LOGIN -->
      <div id="pmLoginView">
        <div class="pm-card">
          <div class="pm-chips" id="pmNameChips"></div>
          <div style="display:grid;gap:10px">
            <label>Nome
              <input id="pmName" list="pmNameList" maxlength="60" placeholder="Seleziona o scrivi il tuo nome" type="text">
              <datalist id="pmNameList"></datalist>
            </label>
            <label>Passcode di gruppo
              <input id="pmPass" type="password" placeholder="Inserisci passcode">
            </label>
            <button id="pmLogin" class="pm-btn">Entra</button>
            <div id="pmMsg" class="pm-muted"></div>
          </div>
        </div>
      </div>

      <!-- APP -->
      <div id="pmAppView" class="hidden">
        <!-- anchor Scelte -->
        <div id="pmChoicesAnchor"></div>
        <!-- monthbar scelte -->
        <div class="pm-monthbar" id="pmMonthBarChoices"></div>

        <div class="pm-card pm-muted">Stati: Presenza · Online</div>
        <div id="pmDays" class="pm-grid"></div>

        <!-- anchor Riepilogo -->
        <div id="pmSummaryAnchor" style="margin-top:8px"></div>
        <div style="display:flex;justify-content:flex-end;margin:10px 0">
          <button id="pmGoSummary" class="pm-btn">Vai al riepilogo</button>
        </div>

        <div class="pm-card" id="pmSummaryCard" style="margin-top:14px">
          <div class="pm-row" style="justify-content:space-between;align-items:center;gap:8px">
            <h3 style="margin:0">Riepilogo (con conteggi per martedì)</h3>
            <div><button id="pmRefreshAll" class="pm-btn">Aggiorna</button></div>
          </div>
          <div class="pm-monthbar" id="pmMonthBarSummary" style="margin-top:8px"></div>
          <div id="pmSummary"></div>
        </div>
      </div>
    </div>

    <!-- overlay spinner -->
    <div id="pmSpinner" class="pm-overlay" aria-live="polite" aria-busy="true">
      <div class="pm-loader" role="status" aria-label="Caricamento"></div>
      <div class="pm-loadtext" id="pmSpinText">Salvataggio in corso…</div>
    </div>
  </div>

  <script>
  (function(){
    const root = document.getElementById('pm-root');
    const weeks = parseInt(root.dataset.weeks || '20', 10);
    const minP  = parseInt(root.dataset.min   || '4', 10);
    const isLogged = root.dataset.logged === '1';
    const initialUser = root.dataset.user || '';

    function q(s, r=document){ return r.querySelector(s); }
    function el(tag, attrs={}, children=[]){
      const e=document.createElement(tag);
      for(const k in attrs){
        if(k==='class') e.className=attrs[k];
        else if(k.startsWith('on')) e.addEventListener(k.substring(2), attrs[k]);
        else e.setAttribute(k, attrs[k]);
      }
      (Array.isArray(children)?children:[children]).forEach(c=>e.append(c?.nodeType?c:document.createTextNode(c||'')));
      return e;
    }

    // spinner
    let _spinCount=0;
    function showSpinner(text){
      _spinCount++;
      const s=q('#pmSpinner'); const t=q('#pmSpinText');
      if(t && text) t.textContent=text;
      if(s) s.style.display='flex';
    }
    function hideSpinner(){
      _spinCount=Math.max(0,_spinCount-1);
      if(_spinCount===0){ const s=q('#pmSpinner'); if(s) s.style.display='none'; }
    }

    // API helper
    async function api(url, method='GET', body=null){
      const opt={method};
      if(body instanceof FormData){ opt.body=body; }
      else if(body){ opt.headers={'Content-Type':'application/json'}; opt.body=JSON.stringify(body); }
      const r = await fetch(url, opt);
      const j = await r.json();
      if(!j?.success) throw new Error(j?.error||'Errore');
      return j;
    }

    // month helpers
    function monthKey(dateStr){ const d=new Date(dateStr); return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); }
    function monthLabel(dateStr){ return new Date(dateStr).toLocaleDateString('it-IT',{month:'long',year:'numeric'}); }

    function buildMonthBar(dates, id, target){
      const bar=q('#'+id); if(!bar) return;
      bar.innerHTML='';
      const seen=new Set();
      dates.forEach(d=>{
        const key=monthKey(d);
        if(seen.has(key)) return; seen.add(key);
        const b=el('button',{class:'pm-month', 'data-month':key}, monthLabel(d));
        b.addEventListener('click', ()=>{
          if(target==='summary'){
            const elMonth=q('#m-'+key); if(elMonth) elMonth.scrollIntoView({behavior:'smooth', block:'start'});
          }else{
            const elDay=document.querySelector('#pmDays [data-month="'+key+'"]');
            if(elDay) elDay.scrollIntoView({behavior:'smooth', block:'start'});
          }
        });
        bar.appendChild(b);
      });
    }

    // login chips + datalist
    function renderNames(names){
      const cont=q('#pmNameChips'); const dl=q('#pmNameList');
      if(!cont||!dl) return;
      const uniq=Array.from(new Set((names||[]).map(n=>(n||'').trim()))).filter(Boolean);
      uniq.sort((a,b)=> a.localeCompare(b,'it',{sensitivity:'base'}));
      cont.innerHTML=''; dl.innerHTML='';
      uniq.forEach(n=>{
        const chip=el('button',{type:'button', class:'pm-chip', onclick:()=>{
          const inp=q('#pmName'); if(inp){ inp.value=n; inp.focus(); }
          try{ localStorage.setItem('pm_name',n);}catch(_){}
        }}, n);
        cont.appendChild(chip);
        const opt=document.createElement('option'); opt.value=n; dl.appendChild(opt);
      });
    }
    async function loadNames(){
      try{ const j=await api('/names'); renderNames(j.data); }catch(e){ console.warn('Nomi non caricati', e); }
    }

    // ---- SEZIONE SCELTE (giorni) ----
    function detailsPanel(day){
      // pannello con nomi in presenza e online
      const panel=el('div',{class:'pm-collapse hidden'});
      const cols=el('div',{class:'pm-columns'},[
        listCol('In presenza', day.lists?.presence || []),
        listCol('Online', day.lists?.online || [])
      ]);
      panel.append(cols);
      return panel;
    }

    function cardDay(d){
      const {date, counts, my}=d;
      const c=el('div',{class:'pm-card', id:'day-'+date, 'data-month':monthKey(date)});

      // head con soglia e pallino
      const sottoSoglia = (counts?.presence || 0) < minP;
      const headLeft = el('div',{},[
        el('div',{class:'pm-name'}, new Date(date).toLocaleDateString('it-IT',{weekday:'long',day:'2-digit',month:'long',year:'numeric'})),
        el('div',{class:'pm-muted'}, date)
      ]);
      const headRight=el('div',{class:'pm-badges'},[
        el('span',{class:'pm-stat'}, `Presenza: ${counts?.presence||0}`),
        el('span',{class:'pm-stat'}, `Online: ${counts?.online||0}`)
      ]);
      const head=el('div',{class:'pm-row', style:'justify-content:space-between;align-items:center'},[
        el('div',{},[
          headLeft,
          sottoSoglia ? el('div',{class:'pm-muted', style:'margin-top:4px'},[ el('span',{class:'pm-dot'}),'sotto soglia di '+minP ]) : ''
        ]),
        headRight
      ]);

      const actions=el('div',{class:'pm-row'},[
        el('button',{class:'pm-pill'+(my==='presence'?' sel':''), onclick:()=>save(date,'presence')},'Presenza'),
        el('button',{class:'pm-pill'+(my==='online'?' sel':''),   onclick:()=>save(date,'online')},  'Online')
      ]);

      const mine=el('div',{class:'pm-muted', style:'margin-top:2px'}, 'Tuo stato: '+(my?({'presence':'Presenza','online':'Online'})[my]:'—'));

      // collapsable
      const caret = el('span',{class:'pm-caret','aria-hidden':'true'},'▸');
      const btnCollapse=el('button',{class:'pm-btn pm-collapse-btn', style:'margin-top:6px', onclick:()=>{
        panel.classList.toggle('hidden');
        caret.classList.toggle('open');
      }}, [caret,' Dettagli presenze']);

      const panel = detailsPanel(d);

      c.append(head,actions,mine,btnCollapse,panel);
      return c;
    }

    function listCol(title, arr){
      const col=el('div',{class:'pm-col'});
      col.append(el('h4',{},title));
      if(arr && arr.length){
        const ul=el('ul',{class:'pm-list'});
        arr.forEach(n=> ul.append(el('li',{}, n)));
        col.append(ul);
      }else{
        col.append(el('div',{class:'pm-muted'}, 'Nessuno'));
      }
      return col;
    }

    async function refreshDays(){
      const cont=q('#pmDays'); if(!cont) return;
      cont.textContent='Caricamento...';
      try{
        const j=await api('/list');
        cont.textContent='';
        const dates=j.days.map(x=>x.date);
        buildMonthBar(dates,'pmMonthBarChoices','choices');
        j.days.forEach(d=>cont.appendChild(cardDay(d)));
      }catch(e){ cont.textContent=e.message||'Errore'; }
    }

    async function save(date,status){
      const btns=document.querySelectorAll('.pm-pill'); btns.forEach(b=>b.disabled=true);
      showSpinner('Salvataggio in corso…');
      try{
        const fd=new FormData(); fd.append('date',date); fd.append('status',status); // status: presence | online
        await api('/save','POST',fd);
        await refreshDays(); await refreshSummary();
      }catch(e){ alert(e.message||'Errore salvataggio'); }
      finally{ btns.forEach(b=>b.disabled=false); hideSpinner(); }
    }

    // ---- RIEPILOGO ----
    function summaryRow(day){
      const d=day.date, counts=day.counts, lists=day.lists||{presence:[],online:[]};
      const alert = (counts?.presence||0) < minP;
      const wrap=el('div',{class:'pm-rowcard', id:'sum-'+d, 'data-month':monthKey(d)});
      const top=el('div',{class:'pm-row', style:'justify-content:space-between;align-items:center'},[
        el('div',{},[
          el('strong',{}, new Date(d).toLocaleDateString('it-IT',{weekday:'long',day:'2-digit',month:'long',year:'numeric'})),
          el('span',{class:'pm-muted'}, ' ('+d+') '),
          alert ? el('span',{class:'pm-muted'}, [el('span',{class:'pm-dot'}), ' Siamo meno di '+minP]) : ''
        ]),
        el('div',{class:'pm-badges'},[
          el('span',{class:'pm-stat'}, `Presenza: ${counts?.presence||0}`),
          el('span',{class:'pm-stat'}, `Online: ${counts?.online||0}`)
        ])
      ]);
      const cols=el('div',{class:'pm-columns', style:'margin-top:10px'},[
        listCol('Presenza', lists.presence),
        listCol('Online',   lists.online),
      ]);
      wrap.append(top,cols);
      return wrap;
    }

    async function refreshSummary(){
      const cont=q('#pmSummary'); if(!cont) return;
      cont.textContent='Caricamento...';
      try{
        const j=await api('/summary');
        cont.textContent='';
        const dates=j.days.map(x=>x.date);
        buildMonthBar(dates,'pmMonthBarSummary','summary');

        let currentMonth='';
        j.days.forEach(day=>{
          const mk=monthKey(day.date);
          if(mk!==currentMonth){
            currentMonth=mk;
            cont.append(el('h3',{id:'m-'+mk, style:'margin:14px 0 8px 0'}, new Date(day.date).toLocaleDateString('it-IT',{month:'long',year:'numeric'})));
          }
          cont.append(summaryRow(day));
        });
      }catch(e){ cont.textContent=e.message||'Errore'; }
    }

    // ---- EVENTI UI ----
    q('#pmLogin')?.addEventListener('click', async ()=>{
      const name=(q('#pmName')?.value||'').trim();
      const pass=(q('#pmPass')?.value||'').trim();
      const msg=q('#pmMsg');
      if(!name||!pass){ msg.textContent='Inserisci nome e passcode'; return; }
      msg.textContent='Accesso...';
      const fd=new FormData(); fd.append('name',name); fd.append('pass',pass);
      try{
        await api('/login','POST',fd);
        // mostra app
        q('#pmLoginView')?.classList.add('hidden');
        q('#pmAppView')?.classList.remove('hidden');
        q('#pmBadge')?.classList.remove('hidden');
        document.querySelectorAll('.js-auth').forEach(b=>b.classList.remove('hidden'));
        const badge=q('#pmBadge'); if(badge) badge.textContent=name;
        await refreshDays(); await refreshSummary();
      }catch(e){
        msg.textContent=e.message||'Errore di accesso';
        alert(e.message||'Errore di accesso');
      }
    });

    function doLogout(){
      showSpinner('Uscita in corso…');
      (async()=>{
        try{ await api('/logout','POST'); }catch(_){}
        q('#pmAppView')?.classList.add('hidden');
        q('#pmLoginView')?.classList.remove('hidden');
        q('#pmBadge')?.classList.add('hidden');
        document.querySelectorAll('.js-auth').forEach(b=>b.classList.add('hidden'));
      })().finally(hideSpinner);
    }
    document.querySelector('.js-logout')?.addEventListener('click', doLogout);

    q('#pmGoSummary')?.addEventListener('click', ()=>{
      (q('#pmSummaryAnchor')||q('#pmSummaryCard'))?.scrollIntoView({behavior:'smooth', block:'start'});
    });
    document.querySelector('.js-go-choices')?.addEventListener('click', ()=>{
      (q('#pmChoicesAnchor')||q('#pmDays'))?.scrollIntoView({behavior:'smooth', block:'start'});
    });
    document.querySelector('.js-go-summary')?.addEventListener('click', ()=>{
      (q('#pmSummaryAnchor')||q('#pmSummaryCard'))?.scrollIntoView({behavior:'smooth', block:'start'});
    });

    q('#pmRefreshAll')?.addEventListener('click', async ()=>{
      showSpinner('Aggiornamento…');
      try{ await refreshDays(); await refreshSummary(); }
      finally{ hideSpinner(); }
    });

    // prefill nome
    try{ const stored=localStorage.getItem('pm_name'); if(stored && q('#pmName')) q('#pmName').value=stored; }catch(_){}

    // init
    if(q('#pmNameChips')) loadNames();
    if(isLogged){
      q('#pmLoginView')?.classList.add('hidden');
      q('#pmAppView')?.classList.remove('hidden');
      const badge=q('#pmBadge');
      if(badge){ badge.textContent = initialUser || ''; badge.classList.remove('hidden'); }
      document.querySelectorAll('.js-auth').forEach(b=>b.classList.remove('hidden'));
      refreshDays(); refreshSummary();
    }
  })();
  </script>
</body>
</html>
